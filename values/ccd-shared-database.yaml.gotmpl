image:
  repository: bitnami/postgresql
  tag: 10.6.0
  pullPolicy: IfNotPresent

fullnameOverride: ccd-shared-database

postgresqlUsername: postgres
postgresqlPassword: postgres
postgresqlDatabase: ccd

initdbScripts:
  init.sh: |
      #!/usr/bin bash

      DB_USERNAME={{ requiredEnv "DB_USERNAME" }}
      DB_PASSWORD={{ requiredEnv "DB_PASSWORD" }}
      DB_STITCHING_USERNAME="emstitch"
      DB_STITCHING_PASSWORD="emstitch"

      # Create roles and databases
      psql -v ON_ERROR_STOP=1 --username postgres --set USERNAME=$DB_USERNAME --set PASSWORD=$DB_PASSWORD <<-EOSQL
        CREATE USER :USERNAME WITH PASSWORD ':PASSWORD';
      EOSQL

      for service in idam ccd_user_profile ccd_definition ccd_data evidence ccd_definition_designer ia_case_api ia_timed_event_service; do
        echo "Database $service: Creating..."
      psql -v ON_ERROR_STOP=1 --username postgres --set USERNAME=$DB_USERNAME --set PASSWORD=$DB_PASSWORD --set DATABASE=$service <<-EOSQL
        CREATE DATABASE :DATABASE
          WITH OWNER = :USERNAME
          ENCODING = 'UTF-8'
          CONNECTION LIMIT = -1;
      EOSQL
        echo "Database $service: Created"
      done

      psql -v ON_ERROR_STOP=1 --username postgres --set USERNAME=$DB_STITCHING_USERNAME --set PASSWORD=$DB_STITCHING_PASSWORD <<-EOSQL
        CREATE USER :USERNAME WITH PASSWORD ':PASSWORD';
      EOSQL

      psql -v ON_ERROR_STOP=1 --username postgres --set USERNAME=$DB_STITCHING_USERNAME --set PASSWORD=$DB_STITCHING_PASSWORD --set DATABASE=emstitch <<-EOSQL
      CREATE DATABASE :DATABASE
      WITH OWNER = :USERNAME
      ENCODING = 'UTF-8'
      CONNECTION LIMIT = -1;
      EOSQL

      echo "Altering $DB_USERNAME user with new password"
      psql -v ON_ERROR_STOP=1 --username postgres -c "ALTER USER $DB_USERNAME WITH PASSWORD '$DB_PASSWORD'";

      echo "Altering $DB_STITCHING_USERNAME user with new password"
      psql -v ON_ERROR_STOP=1 --username postgres -c "ALTER USER $DB_STITCHING_USERNAME WITH PASSWORD '$DB_STITCHING_PASSWORD'";


service:
  type: ClusterIP
  port: 5432
persistence:
  enabled: true
  mountPath: /bitnami/postgresql
  subPath: ""
  accessModes:
    - ReadWriteOnce
  size: 8Gi

updateStrategy:
  type: RollingUpdate

resources:
  requests:
    memory: 256Mi
    cpu: 250m

networkPolicy:
  enabled: false
  allowExternal: true
